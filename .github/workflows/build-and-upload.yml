# .github/workflows/build-and-upload.yml
name: Build and Upload Offline Images

on:
  workflow_dispatch:
    inputs:
      images:
        description: 'é•œåƒåˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªï¼ˆæ”¯æŒ tag æˆ–å®Œæ•´ digestï¼‰'
        required: true
        type: string
      platform:
        description: 'ç›®æ ‡å¹³å°ï¼ˆå¦‚ linux/amd64ï¼‰'
        required: false
        default: 'linux/amd64'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (multi-arch support)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull and Save Images with Proper References
        run: |
          mkdir -p output

          # å¤„ç†å¤šè¡Œè¾“å…¥
          while IFS= read -r image; do
            [[ -z "$image" ]] && continue

            echo "ğŸ“¥ Pulling image: $image"
            docker pull "$image"

            # åˆ¤æ–­æ˜¯å¦ä¸º digest æ ¼å¼ï¼ˆåŒ…å« @sha256:ï¼‰
            if [[ "$image" == *@sha256:* ]]; then
              # æå–ä»“åº“éƒ¨åˆ†ï¼ˆç§»é™¤ @sha256:...ï¼‰
              repo_part="${image%@sha256:*}"
              # åˆ›å»ºä¸´æ—¶ tag åç§°ï¼ˆç¡®ä¿åˆæ³•ï¼‰
              temp_tag="${repo_part}:offline-load"
              echo "ğŸ·ï¸  Tagging as temporary reference: $temp_tag"
              docker tag "$image" "$temp_tag"
              # å®‰å…¨æ–‡ä»¶åï¼ˆæ›¿æ¢ / å’Œ : ä¸º _ï¼‰
              safe_name=$(echo "$temp_tag" | sed 's/[\/:@]/_/g')
              docker save "$temp_tag" -o "output/${safe_name}.tar"
            else
              # æ™®é€š tag é•œåƒï¼Œç›´æ¥ä¿å­˜
              safe_name=$(echo "$image" | sed 's/[\/:@]/_/g')
              docker save "$image" -o "output/${safe_name}.tar"
            fi

            echo "ğŸ“¦ Saved as: output/${safe_name}.tar"
          done <<< "${{ github.event.inputs.images }}"

      - name: List saved images (for debugging)
        run: ls -lh output/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: offline-images
          path: ./output/*.tar
          retention-days: 7
