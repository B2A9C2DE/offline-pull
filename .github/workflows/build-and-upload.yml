# .github/workflows/build-and-upload.yml
name: Build and Upload Images

on:
  workflow_dispatch:
    inputs:
      images:
        description: 'é•œåƒåˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ª'
        required: true
        type: string
      platform:
        description: 'ç›®æ ‡å¹³å°ï¼ˆå¦‚ linux/amd64ï¼‰'
        required: false
        default: 'linux/amd64'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (æ”¯æŒå¤šæ¶æ„)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull and Save Images
        run: |
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p output

          # è¯»å–å¤šè¡Œè¾“å…¥ï¼ˆæ¥è‡ª workflow_dispatchï¼‰
          while IFS= read -r image; do
            if [[ -n "$image" ]]; then
              echo "ğŸ“¥ Pulling: $image"
              docker pull "$image"
              # æ¸…ç†æ–‡ä»¶åï¼ˆæ›¿æ¢ / å’Œ : ä¸º _ï¼‰
              safe_name=$(echo "$image" | sed 's/[\/:]/_/g')
              docker save "$image" -o "output/${safe_name}.tar"
            fi
          done <<< "${{ github.event.inputs.images }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: offline-images
          path: ./output/*.tar
