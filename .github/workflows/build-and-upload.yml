# .github/workflows/build-and-upload.yml
name: Build and Upload Offline Images

on:
  workflow_dispatch:
    inputs:
      images:
        description: 'é•œåƒåˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªï¼ˆæ”¯æŒ repo:tagã€repo@sha256:...ã€repo:tag@sha256:...ï¼‰'
        required: true
        type: string
      platform:
        description: 'ç›®æ ‡å¹³å°ï¼ˆå¦‚ linux/amd64ï¼‰'
        required: false
        default: 'linux/amd64'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (multi-arch support)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull and Save Images with Proper References
        run: |
          mkdir -p output

          # è¾…åŠ©å‡½æ•°ï¼šä»é•œåƒå¼•ç”¨ä¸­æå–çº¯ä»“åº“åï¼ˆä¸å« tag æˆ– digestï¼‰
          get_repo_name() {
            local img="$1"
            # ç§»é™¤ @sha256:... éƒ¨åˆ†
            local no_digest="${img%@sha256:*}"
            # å¦‚æœåŒ…å« :tag ä¸”æœ‰ /ï¼ˆè¯´æ˜æ˜¯ repo:tag è€Œé localhost:5000ï¼‰
            if [[ "$no_digest" == *":"* ]] && [[ "$no_digest" == */* ]]; then
              echo "${no_digest%:*}"
            else
              # å¯èƒ½æ˜¯ nginx@sha256:... æˆ– localhost:5000/imgï¼Œä¿ç•™åŸæ ·
              echo "$no_digest"
            fi
          }

          # å¤„ç†å¤šè¡Œè¾“å…¥
          while IFS= read -r image; do
            [[ -z "$image" ]] && continue

            echo "ğŸ“¥ Pulling image: $image"
            docker pull "$image"

            if [[ "$image" == *@sha256:* ]]; then
              # æå–çº¯ä»“åº“åï¼ˆå¦‚ registry.k8s.io/ingress-nginx/kube-webhook-certgenï¼‰
              repo_only=$(get_repo_name "$image")
              temp_tag="${repo_only}:offline-load"
              echo "ğŸ·ï¸  Tagging as temporary reference: $temp_tag"
              docker tag "$image" "$temp_tag"
              safe_name=$(echo "$temp_tag" | sed 's/[\/:@]/_/g')
              docker save "$temp_tag" -o "output/${safe_name}.tar"
            else
              # æ™®é€š tag é•œåƒï¼ˆå¦‚ nginx:latestï¼‰
              safe_name=$(echo "$image" | sed 's/[\/:@]/_/g')
              docker save "$image" -o "output/${safe_name}.tar"
            fi

            echo "ğŸ“¦ Saved as: output/${safe_name}.tar"
          done <<< "${{ github.event.inputs.images }}"

      - name: List saved images (for debugging)
        run: ls -lh output/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: offline-images
          path: ./output/*.tar
          retention-days: 7
